<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/chat.css}">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background-color: #4A76A8;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fff;
        }
        .message-bubble {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .sent-message {
            background-color: #4A76A8;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .received-message {
            background-color: #e5e5ea;
            color: black;
        }
        .message-info {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        .input-area {
            padding: 15px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }
        .message-input {
            resize: none;
            border: 1px solid #ddd;
            border-radius: 18px;
            padding: 10px 15px;
            height: 60px;
        }
        .send-button {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-info {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
        }
        .logout-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
        }
        .logout-link:hover {
            color: white;
            text-decoration: underline;
        }
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .typing-indicator {
            color: #666;
            font-style: italic;
            font-size: 0.8rem;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <h4>Web Chat</h4>
        <div class="user-info"
             sec:authentication="principal.attributes.first_name + ' ' + principal.attributes.last_name">
                <span sec:authorize="isAuthenticated()">
                    Welcome, <span sec:authentication="principal.attributes.first_name"></span>!
                    <a href="/logout" class="logout-link">Logout</a>
                </span>
        </div>
    </div>

    <div id="messagesArea" class="messages-area">
        <div th:each="message : ${messages}" th:object="${message}">
            <div th:class="${#authentication.name == message.user.username} ? 'message-bubble sent-message' : 'message-bubble received-message'">
                <div class="d-flex align-items-start">
                    <img th:if="${message.user.avatarUrl}" class="user-avatar" th:src="${message.user.avatarUrl}"
                         alt="User Avatar">
                    <div>
                        <strong th:text="*{user.username}">Username</strong><br>
                        <span th:text="*{content}">Message content</span>
                        <div class="message-info">
                            <span th:text="*{#temporals.createLocalDateTime(timestamp).format('HH:mm')}">Time</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="input-area">
        <div class="d-flex">
            <textarea id="messageInput" class="form-control message-input"
                      placeholder="Type your message here..."></textarea>
            <button id="sendButton" class="btn btn-primary send-button ms-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send"
                     viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.492-7.417Z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    var stompClient = null;
    var currentUser = /*[[${currentUser}]]*/ null;

    // Function to format timestamp
    function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/messages', function(messageOutput){
                showMessage(JSON.parse(messageOutput.body));
            });
        });
    }

    function sendMessage() {
        var messageContent = document.getElementById('messageInput').value.trim();
        if (messageContent && stompClient) {
            var message = {
                content: messageContent,
                userId: currentUser ? currentUser.id : null
            };

            stompClient.send("/app/sendMessage", {}, JSON.stringify(message));
            document.getElementById('messageInput').value = '';
        }
    }

    function showMessage(message) {
        var messagesArea = document.getElementById('messagesArea');
        var messageElement = document.createElement('div');
        var isCurrentUser = currentUser && message.user && message.user.id === currentUser.id;
        messageElement.className = isCurrentUser ? 'message-bubble sent-message' : 'message-bubble received-message';

        var avatarHtml = message.user && message.user.avatarUrl ?
            '<img class="user-avatar" src="' + message.user.avatarUrl + '" alt="User Avatar">' : '';

        messageElement.innerHTML =
            '<div class="d-flex align-items-start">' +
            avatarHtml +
            '<div>' +
            '<strong>' + (message.user ? message.user.username : 'Unknown') + '</strong><br>' +
            '<span>' + message.content + '</span>' +
            '<div class="message-info">' +
            formatTimestamp(message.timestamp) +
            '</div>' +
            '</div>' +
            '</div>';

        messagesArea.appendChild(messageElement);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function() {
        connect();

        document.getElementById('sendButton').addEventListener('click', sendMessage);

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-scroll to bottom
        var messagesArea = document.getElementById('messagesArea');
        messagesArea.scrollTop = messagesArea.scrollHeight;
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
